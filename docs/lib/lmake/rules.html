<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2023 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2023 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="c1"># This file is part of the open-lmake distribution (git@github.com:cesar-douady/open-lmake.git)</span>
<span class="c1"># Copyright (c) 2023-2026 Doliam</span>
<span class="c1"># This program is free software: you can redistribute/modify under the terms of the GPL-v3 (https://www.gnu.org/licenses/gpl-3.0.html).</span>
<span class="c1"># This program is distributed WITHOUT ANY WARRANTY, without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>

<span class="s1">&#39;lmake.rules source file (as named in lmake.rules.__file__) is thoroughly commented, please refer to it.&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>     <span class="k">as</span> <span class="nn">_sys</span>
<span class="kn">import</span> <span class="nn">os</span>      <span class="k">as</span> <span class="nn">_os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">_osp</span>
<span class="kn">import</span> <span class="nn">pwd</span>     <span class="k">as</span> <span class="nn">_pwd</span>
<span class="kn">import</span> <span class="nn">re</span>      <span class="k">as</span> <span class="nn">_re</span>
<span class="kn">import</span> <span class="nn">signal</span>  <span class="k">as</span> <span class="nn">_signal</span>

<span class="kn">import</span> <span class="nn">lmake</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">autodeps</span><span class="p">,</span><span class="n">pdict</span>

<span class="n">_lmake_lib</span> <span class="o">=</span> <span class="n">_osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">_osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">_RuleBase</span> <span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">lmake</span><span class="o">.</span><span class="n">_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="c1"># list of rules</span>
    <span class="n">__special__</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># combined attributes are aggregated, combine is itself combined but not listed here as it is dealt with separately</span>
    <span class="c1"># for dict, a value of None   discards the entry, sequences are mapped to dict with value True and non sequence is like a singleton</span>
    <span class="c1"># for set , a key   of -&lt;key&gt; discards &lt;key&gt;    , sequences are mapped to set                  and non sequence is like a singleton</span>
    <span class="c1"># for list &amp; tuple, entries are concatenated    , sequences are mapped to list/tuple           and non sequence is like a singleton</span>
    <span class="n">combine</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;stems&#39;</span>
    <span class="p">,</span>   <span class="s1">&#39;targets&#39;</span> <span class="p">,</span> <span class="s1">&#39;side_targets&#39;</span>
    <span class="p">,</span>   <span class="s1">&#39;deps&#39;</span>    <span class="p">,</span> <span class="s1">&#39;side_deps&#39;</span>
    <span class="p">,</span>   <span class="s1">&#39;environ&#39;</span> <span class="p">,</span> <span class="s1">&#39;environ_resources&#39;</span> <span class="p">,</span> <span class="s1">&#39;environ_ancillary&#39;</span>
    <span class="p">,</span>   <span class="s1">&#39;resources&#39;</span>
    <span class="p">,</span>   <span class="s1">&#39;views&#39;</span>
    <span class="p">}</span>
    <span class="c1"># atributes listed in paths must be part of a combined dict and values are concatenated :</span>
    <span class="c1"># if a value contains &#39;...&#39; surrounded by separators, or at the beginning or end, these &#39;...&#39; are replaced by the inherited value</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;environ.PATH&#39;</span>            <span class="p">:</span> <span class="s1">&#39;:&#39;</span>
    <span class="p">,</span>   <span class="s1">&#39;environ.LD_LIBRARY_PATH&#39;</span> <span class="p">:</span> <span class="s1">&#39;:&#39;</span>
    <span class="p">,</span>   <span class="s1">&#39;environ.MANPATH&#39;</span>         <span class="p">:</span> <span class="s1">&#39;:&#39;</span>
    <span class="p">,</span>   <span class="s1">&#39;environ.PYTHONPATH&#39;</span>      <span class="p">:</span> <span class="s1">&#39;:&#39;</span>
    <span class="p">}</span>
<span class="c1">#   name                         # must be specific for each rule, defaults to class name</span>
<span class="c1">#   job_name                     # defaults to first target</span>
    <span class="n">stems</span>   <span class="o">=</span> <span class="p">{}</span>                 <span class="c1"># defines stems as regexprs for use in targets &amp; deps, e.g. {&#39;File&#39;:r&#39;.*&#39;}</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c1"># patterns used to trigger rule execution, refers to stems above through {} notation, e.g. {&#39;OBJ&#39;:&#39;{File}.o&#39;}</span>
    <span class="c1">#                            # in case of multiple matches, first matching entry is considered, others are ignored</span>
    <span class="c1">#                            # targets may have flags (use - to reset), e.g. { &#39;TMP&#39; : (&#39;{File}.tmp/{Tmp*}&#39;,&#39;Incremental&#39;,&#39;-Essential&#39;) }, flags may be :</span>
    <span class="c1">#                            #   flag         | default   | description</span>
    <span class="c1">#                            #   -------------+-----------+--------------------------------------------------------------------------------------------</span>
    <span class="c1">#                            #   Essential    | if static | show in graphic flow</span>
    <span class="c1">#                            #   Incremmental |           | file is not unlinked before job execution and can be read before written to or unlinked</span>
    <span class="c1">#                            #   SourceOk     |           | no error if target is actually a source</span>
    <span class="c1">#                            #   NoUniquify   |           | dont uniquify file if incremental and file has several links to it</span>
    <span class="c1">#                            #   NoWarning    |           | dont warn if either uniquified or unlinked before job execution and file was generated by another job</span>
<span class="c1">#   target                       # syntactic sugar for targets = {&#39;&lt;stdout&gt;&#39;:&lt;value&gt;} (except that it is allowed)</span>
    <span class="n">side_targets</span> <span class="o">=</span> <span class="p">{}</span>            <span class="c1"># patterns used to add flags based on pattern matching refering to stems above through {} notation, e.g. {&#39;CACHE&#39;:&#39;{File}.cache&#39;,&#39;incremental&#39;}</span>
    <span class="n">side_deps</span>    <span class="o">=</span> <span class="p">{}</span>            <span class="c1"># .</span>

<span class="k">class</span> <span class="nc">Rule</span><span class="p">(</span><span class="n">_RuleBase</span><span class="p">)</span> <span class="p">:</span>
<span class="c1">#   auto_mkdir          = False                     # auto mkdir dir in case of chdir</span>
<span class="c1">#   autodep             = &#39;ld_audit&#39;                # autodep method : none, ld_audit, ld_preload, ld_preload_jemalloc, ptrace</span>
<span class="c1">#   backend             = &#39;local&#39;                   # may be set anywhere in the inheritance hierarchy if execution must be remote</span>
<span class="c1">#   check_abs_paths     = False                     # check that absolute paths inside the repo are not stored in targets</span>
<span class="c1">#   chroot_dir          = &#39;/&#39;                       # chroot dir to execute cmd (if None, empty or absent, no chroot is not done)</span>
<span class="c1">#   chroot_actions      = ()                        # actions to carry out when chroot to chroot_dir, a list/tuple of : &#39;user_name&#39;, &#39;resolve_conf&#39;</span>
<span class="c1">#   cache               = None                      # cache used to store results for this rule. None means no caching</span>
<span class="c1">#   cmd                                             # runnable if set anywhere in the inheritance hierarchy (as shell str or python function), chained if several definitions</span>
<span class="c1">#   compression         = None                      # compression to use when caching :</span>
    <span class="c1">#                                               # - if None  : no compression</span>
    <span class="c1">#                                               # - if a str : the compression method : zlib or zstd, level defaults to 1</span>
    <span class="c1">#                                               # - if a int : the compression level : a int between 0 (no compression) and 9 (best and slowest), method defaults zstd if supported, else zlib</span>
    <span class="c1">#                                               # - if a tuple : (method,level), as described above</span>
<span class="c1">#   cwd                 = &#39;&#39;                        # cwd in which to run cmd. targets/deps are relative to it unless they start with /, in which case it means top root dir</span>
    <span class="c1">#                                               #   defaults to the nearest root dir of the module in which the rule is defined</span>
    <span class="n">deps</span>                <span class="o">=</span> <span class="p">{}</span>                        <span class="c1"># patterns used to express explicit depencies, full f-string notation with stems and targets defined, e.g. {&#39;SRC&#39;:&#39;{File}.c&#39;}</span>
    <span class="c1">#                                               #   deps may have flags (use - to reset), e.g. {&#39;TOOL&#39;:(&#39;tool&#39;,&#39;Critical&#39;,&#39;-Essential&#39;)}, flags may be :</span>
    <span class="c1">#                                               #   flag        | default | description</span>
    <span class="c1">#                                               #   ------------+---------+--------------------------------------------------------------------------------------------</span>
    <span class="c1">#                                               #   Essential   | x       | show in graphic flow</span>
    <span class="c1">#                                               #   Critical    |         | following deps are ignored if this dep is modified</span>
    <span class="c1">#                                               #   IgnoreError |         | accept dep even if generated in error</span>
<span class="c1">#   dep                                             # syntactic sugar for deps = {&#39;&lt;stdin&gt;&#39;:&lt;value&gt;} (except that it is allowed)</span>
<span class="c1">#   ete                 = 0                         # Estimated Time Enroute, initial guess for job exec time (in s)</span>
<span class="c1">#   force               = False                     # if set, jobs are never up-to-date, they are rebuilt every time they are needed</span>
<span class="c1">#   keep_tmp            = False                     # keep tmp dir after job execution</span>
<span class="c1">#   kill_daemons        = False                     # ensure no process survive after job end</span>
    <span class="n">kill_sigs</span>           <span class="o">=</span> <span class="p">()</span>                        <span class="c1"># signals to use to kill jobs (send them in turn followed by SIGKILL), 1 second apart, until job dies</span>
    <span class="c1">#                                               #   0&#39;s may be used to set a larger delay between 2 trials)</span>
<span class="c1">#   lmake_root          = &#39;/my/installs/open-lmake&#39; # absolute path of the open-lmake installation dir to be used by job (default is current installation dir)</span>
    <span class="c1">#                                               #   dir is first searched in chroot_dir then in the native root</span>
<span class="c1">#   lmake_view          = &#39;/lmake&#39;                  # absolute path under which the open-lmake installation dir is seen (if None, empty, or absent, no bind mount is done)</span>
    <span class="n">max_retries_on_lost</span> <span class="o">=</span>   <span class="mi">1</span>                       <span class="c1"># max number of retries in case of job lost. 1 is a reasonable value</span>
<span class="c1">#   max_runs            =   0                       # maximum number a job can be run in a single lmake command, unlimited if None or 0</span>
    <span class="n">max_stderr_len</span>      <span class="o">=</span> <span class="mi">100</span>                       <span class="c1"># maximum number of stderr lines shown in output (full content is accessible with lshow -e), 100 is a reasonable compromise</span>
    <span class="n">max_submits</span>         <span class="o">=</span>  <span class="mi">10</span>                       <span class="c1"># maximum number a job can be submitted in a single lmake command, unlimited if None or 0</span>
<span class="c1">#   prio                = 0                         # in case of ambiguity, rules are selected with highest prio first</span>
    <span class="n">python</span>              <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;$PYTHON&#39;</span><span class="p">,)</span>              <span class="c1"># python used for callable cmd</span>
<span class="c1">#   readdir_ok          = False                     # if set, listing a local non-ignored dir is not an error</span>
<span class="c1">#   repo_view           = &#39;/repo&#39;                   # absolute path under which the root dir of the repo is seen (if None, empty, or absent, no bind mount is done)</span>
    <span class="n">shell</span>               <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;$SHELL&#39;</span><span class="p">,)</span>               <span class="c1"># shell  used for str      cmd (_sh is usually /bin/sh which may test for dir existence before chdir, which defeats auto_mkdir)</span>
    <span class="n">start_delay</span>         <span class="o">=</span> <span class="mi">3</span>                         <span class="c1"># delay before sending a start message if job is not done by then, 3 is a reasonable compromise</span>
<span class="c1">#   stderr_ok           = False                     # if set, writing to stderr is not an error but a warning</span>
<span class="c1">#   timeout             = None                      # timeout allocated to job execution (in s), must be None or an int</span>
<span class="c1">#   tmp_view            = &#39;/tmp&#39;                    # view under which tmp dir is seen, may be :</span>
    <span class="c1">#                                               #   - not specified, &#39;&#39; or None : do not mount tmp dir</span>
    <span class="c1">#                                               #   - str                       : must be an absolute path which tmp dir is mounted on.</span>
    <span class="c1">#                                               #   physical tmp dir is :</span>
    <span class="c1">#                                               #   -      a private sub-dir in $TMPDIR if provided in the environment</span>
    <span class="c1">#                                               #   - else a private sub-dir in the LMAKE dir</span>
<span class="c1">#   use_script          = False                     # use a script to run job rather than calling interpreter with -c</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">(</span>                                <span class="c1"># job execution environment, handled as part of cmd (trigger rebuild upon modification)</span>
        <span class="n">HOME</span> <span class="o">=</span> <span class="s1">&#39;$REPO_ROOT&#39;</span>                         <span class="c1"># favor repeatability by hiding use home dir some tools use at start up time</span>
    <span class="p">,</span>   <span class="n">PATH</span> <span class="o">=</span> <span class="s1">&#39;$LMAKE_ROOT/bin:$STD_PATH&#39;</span>
    <span class="p">)</span>
    <span class="n">environ_resources</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">()</span>                     <span class="c1"># job execution environment, handled as resources (trigger rebuild upon modification for jobs in error)</span>
    <span class="n">environ_ancillary</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">(</span>                      <span class="c1"># job execution environment, does not trigger rebuild upon modification</span>
        <span class="n">UID</span>  <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">getuid</span><span class="p">())</span>                    <span class="c1"># this may be necessary by some tools and usually does not lead to user specific configuration</span>
    <span class="p">,</span>   <span class="n">USER</span> <span class="o">=</span> <span class="n">_pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">getuid</span><span class="p">())</span><span class="o">.</span><span class="n">pw_name</span>  <span class="c1"># .</span>
    <span class="p">)</span>
    <span class="n">resources</span> <span class="o">=</span> <span class="p">{</span>                                   <span class="c1"># used in conjunction with backend to inform it of the necessary resources to execute the job, same syntax as deps</span>
        <span class="s1">&#39;cpu&#39;</span> <span class="p">:</span> <span class="mi">1</span>                                   <span class="c1"># number of cpu&#39;s to allocate to job</span>
<span class="c1">#   ,   &#39;mem&#39; : &#39;100M&#39;                              # memory to allocate to job</span>
<span class="c1">#   ,   &#39;tmp&#39; : &#39;1G&#39;                                # temporary disk space to allocate to job</span>
    <span class="p">}</span>                                               <span class="c1"># follow the same syntax as deps</span>

<span class="k">class</span> <span class="nc">AntiRule</span><span class="p">(</span><span class="n">_RuleBase</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">__special__</span> <span class="o">=</span> <span class="s1">&#39;anti&#39;</span>       <span class="c1"># AntiRule&#39;s are not executed, but defined at high enough prio, prevent other rules from being selected</span>
    <span class="n">prio</span>        <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="c1"># default to high prio as the goal of AntiRule&#39;s is to hide other rules</span>

<span class="k">class</span> <span class="nc">SourceRule</span><span class="p">(</span><span class="n">_RuleBase</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">__special__</span> <span class="o">=</span> <span class="s1">&#39;generic_src&#39;</span>
    <span class="n">prio</span>        <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HomelessRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">)</span> <span class="p">:</span>
    <span class="s1">&#39;base rule to redirect the HOME environment variable to tmp&#39;</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">(</span><span class="n">HOME</span><span class="o">=</span><span class="s1">&#39;$TMPDIR&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TraceRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">)</span> <span class="p">:</span>
    <span class="s1">&#39;base rule to trace shell commands to stdout&#39;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        exec 3&gt;&amp;1</span>
<span class="s1">        export BASH_XTRACEFD=3</span>
<span class="s1">        set -x</span>
<span class="s1">    &#39;&#39;&#39;</span>

<span class="k">class</span> <span class="nc">AliasRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">)</span> <span class="p">:</span>
    <span class="s1">&#39;base rule to make target an alias for deps&#39;</span>
    <span class="n">force</span>        <span class="o">=</span> <span class="kc">True</span>                                 <span class="c1"># force deps to always be built as they are guaranted available when job runs</span>
    <span class="n">side_targets</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;__PHONY__&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;{*:.*}&#39;</span><span class="p">,</span><span class="s1">&#39;phony&#39;</span><span class="p">)</span> <span class="p">}</span> <span class="c1"># targets are useless and are typically not built</span>
    <span class="k">def</span> <span class="nf">cmd</span><span class="p">()</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lmake</span><span class="o">.</span><span class="n">depend</span><span class="p">(</span> <span class="o">*</span><span class="n">deps</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="kc">True</span> <span class="p">))</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        # take care of managing awkward deps : single quote deps, replacing &#39; by &#39;&quot;&#39;&quot;&#39; as &#39; protects against everything but &#39;</span>
<span class="s1">        ldepend -vR {&#39; &#39;.join(&quot;&#39;&quot;+v.replace(&quot;&#39;&quot;,&quot;&#39;&quot;+&#39;&quot;&#39;+&quot;&#39;&quot;+&#39;&quot;&#39;+&quot;&#39;&quot;)+&quot;&#39;&quot; for v in deps.values())}</span>
<span class="s1">    &#39;&#39;&#39;</span>

<span class="k">class</span> <span class="nc">DirtyRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">side_targets</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;__NO_MATCH__&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="s1">&#39;{*:.*}&#39;</span><span class="p">,</span><span class="s1">&#39;Incremental&#39;</span><span class="p">,</span><span class="s1">&#39;NoWarning&#39;</span><span class="p">)</span> <span class="p">}</span>

<span class="k">class</span> <span class="nc">_PyRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">)</span> <span class="p">:</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">(</span><span class="n">PYTHONPATH</span><span class="o">=</span><span class="s1">&#39;$LMAKE_ROOT/lib&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Py2Rule</span><span class="p">(</span><span class="n">_PyRule</span><span class="p">)</span> <span class="p">:</span>
    <span class="s1">&#39;base rule that handle pyc creation when importing modules in python&#39;</span>
    <span class="c1"># python reads the pyc file and compare stored date with actual py date (through a stat), but semantic is to read the py file</span>
    <span class="n">side_targets</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;__PYC__&#39;</span> <span class="p">:</span> <span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;{*:(?:.+/)?}{*:\w+}.pyc&#39;</span> <span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">,</span><span class="s1">&#39;top&#39;</span> <span class="p">)</span> <span class="p">}</span>
    <span class="n">python</span>       <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;$PYTHON2&#39;</span><span class="p">,)</span>
    <span class="n">environ</span>      <span class="o">=</span> <span class="n">pdict</span><span class="p">(</span> <span class="n">LD_LIBRARY_PATH</span><span class="o">=</span><span class="s1">&#39;$PYTHON2_LD_LIBRARY_PATH&#39;</span> <span class="p">)</span>
    <span class="c1"># this will be executed before cmd() of concrete subclasses as cmd() are chained in case of inheritance</span>
    <span class="k">def</span> <span class="nf">cmd</span><span class="p">()</span> <span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="k">assert</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="o">==</span><span class="mi">2</span> <span class="p">,</span> <span class="s1">&#39;cannot use Py2Rule with python</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">lmake.import_machinery</span> <span class="kn">import</span> <span class="n">fix_import</span>
        <span class="n">fix_import</span><span class="p">()</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>       <span class="c1"># support shell cmd&#39;s that may launch python as a subprocess XXX! : manage to execute fix_import()</span>
<span class="k">class</span> <span class="nc">Py3Rule</span><span class="p">(</span><span class="n">_PyRule</span><span class="p">)</span> <span class="p">:</span>
    <span class="s1">&#39;base rule that handle pyc creation when importing modules in python&#39;</span>
    <span class="c1"># python reads the pyc file and compare stored date with actual py date (through a stat), but semantic is to read the py file (guaranteed if fix_import is called)</span>
    <span class="n">side_targets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;__PYC__&#39;</span>     <span class="p">:</span> <span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;{*:(?:.+/)?}__pycache__/{*:\w+}.{*:[\w.-]+}.pyc&#39;</span>         <span class="p">,</span> <span class="s1">&#39;incremental&#39;</span><span class="p">,</span><span class="s1">&#39;top&#39;</span> <span class="p">)</span>
    <span class="p">,</span>   <span class="s1">&#39;__PYC_TMP__&#39;</span> <span class="p">:</span> <span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;{*:(?:.+/)?}__pycache__/{*:\w+}.{*:[\w.-]+}.pyc.{*:\d+}&#39;</span> <span class="p">,</span> <span class="s1">&#39;ignore&#39;</span>     <span class="p">,</span><span class="s1">&#39;top&#39;</span> <span class="p">)</span> <span class="c1"># these are temporary files guaranteed unique by python</span>
    <span class="p">}</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">(</span> <span class="n">LD_LIBRARY_PATH</span><span class="o">=</span><span class="s1">&#39;$PYTHON_LD_LIBRARY_PATH&#39;</span> <span class="p">)</span>
    <span class="c1"># this will be executed before cmd() of concrete subclasses as cmd() are chained in case of inheritance</span>
    <span class="k">def</span> <span class="nf">cmd</span><span class="p">()</span> <span class="p">:</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="k">assert</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="o">==</span><span class="mi">3</span> <span class="p">,</span> <span class="s1">&#39;cannot use Py3Rule with python</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">lmake.import_machinery</span> <span class="kn">import</span> <span class="n">fix_import</span>
        <span class="n">fix_import</span><span class="p">()</span>                                  <span class="c1"># deps/targets to pyc files are ignored, so nothing to do</span>
    <span class="n">cmd</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>                                    <span class="c1"># support shell cmd&#39;s that may launch python as a subprocess XXX! : manage to execute fix_import()</span>

<span class="n">PyRule</span> <span class="o">=</span> <span class="n">Py3Rule</span>

<span class="k">class</span> <span class="nc">RustRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">)</span> <span class="p">:</span>
    <span class="s1">&#39;base rule for use by any code written in Rust (including cargo and rustc that are written in rust)&#39;</span>
    <span class="n">autodep</span> <span class="o">=</span> <span class="s1">&#39;ld_preload&#39;</span>                                                                               <span class="c1"># rust use a dedicated loader that does not call auditing code when using ld_audit</span>
    <span class="k">if</span> <span class="s1">&#39;RUSTUP_HOME&#39;</span> <span class="ow">in</span> <span class="n">_os</span><span class="o">.</span><span class="n">environ</span> <span class="p">:</span>
        <span class="n">environ</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;RUSTUP_HOME&#39;</span> <span class="p">:</span> <span class="n">_os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;RUSTUP_HOME&#39;</span><span class="p">]</span>                                                   <span class="c1"># ensure var is passed to job</span>
        <span class="p">,</span>   <span class="s1">&#39;PATH&#39;</span>        <span class="p">:</span> <span class="n">_osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;RUSTUP_HOME&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;/.cargo/bin:...&#39;</span>                   <span class="c1"># ... stands for inherited value</span>
        <span class="p">}</span>

<span class="k">class</span> <span class="nc">DirRule</span><span class="p">(</span><span class="n">Rule</span><span class="p">)</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Base rule to ensure the existence of a dir by generating a target within said dir.</span>
<span class="sd">        The default marker is &#39;...&#39;.</span>
<span class="sd">        Usage :</span>
<span class="sd">            class MyDirRule(DirRule) : pass</span>
<span class="sd">        or :</span>
<span class="sd">            class MyDirRule(DirRule) : marker=&#39;my_marker&#39;</span>
<span class="sd">        Note : in case of conflict with other rules, you may have to adjust prio</span>
<span class="sd">        Then to ensure that dir exists :</span>
<span class="sd">            lmake.depend(dir+&#39;/&#39;+marker)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">virtual</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">marker</span>  <span class="o">=</span> <span class="s1">&#39;...&#39;</span>
    <span class="n">target</span>  <span class="o">=</span> <span class="sa">fr</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">Dir:.+</span><span class="se">}}</span><span class="s1">/</span><span class="si">{</span><span class="n">marker</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="s1">&#39;local&#39;</span>                 <span class="c1"># command is faster than any other backend overhead</span>
    <span class="n">cmd</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</pre></div>
</body>
</html>
