<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Codec - open-lmake documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">open-lmake documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- This file is part of the open-lmake distribution (git@github.com:cesar-douady/open-lmake.git)-->
<!-- Copyright (c) 2023-2026 Doliam-->
<!-- This program is free software: you can redistribute/modify under the terms of the GPL-v3 (https://www.gnu.org/licenses/gpl-3.0.html).-->
<!-- This program is distributed WITHOUT ANY WARRANTY, without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.-->
<h1 id="encoding-and-decoding"><a class="header" href="#encoding-and-decoding">Encoding and decoding</a></h1>
<p>In projects with heavily parameterized files, filenames can become extremely long.
Think of the mere compilation of a C++ file <code>foo.c</code>.
You may want to specify:</p>
<ul>
<li>the optimization level through a <code>-O</code> argument</li>
<li>Whether debug checks are enable through the definition of <code>NDEBUG</code></li>
<li>a trace level through the definition of a macro such as <code>TRACE_LEVEL</code></li>
<li>whether and how to instrument with <code>-fsanitize</code></li>
<li>whether some internal data are 32 or 64 bits</li>
<li>whether to use a reference algorithm or an agressively optimized one used in production.</li>
<li>...</li>
</ul>
<p>You may want to be able to generate any combination so as, for example, compare the output of any 2 of them for validation purpose.
You easily end up with an object file with a name such as <code>foo.O3.NDEBUG.TRACE_LEVEL=1.sanitize=address.32.o</code>.
Already 50 characters or so.
In a real projects, filenames can easily be 200, 300, 400 characters long.</p>
<p>As long as the filename, with adequate shorthands such as using <code>TL</code> instead of <code>TRACE_LEVEL</code> fits within a few hundreds of characters, the situation is heavy but manageable.
But if you need, say 3000 characters to specify a file, then it becomes completely impractical.</p>
<p>When the configuration can be devised in advance, in a stable way, an efficient alternative is to create a file to contain it, which becomes a configuration name,
and just specify the configuration name in the generated file.</p>
<p>In the example above, you may have a file <code>test.opts</code> that contains options for testing and <code>prod.opts</code> that contains options for production.
then, your object file is simply named <code>foo.test.o</code> or <code>foo.prod.o</code>.</p>
<p>When it is not, the situation is more complex and you need to automatically generate these configuration files with reasonably short names.
A practical and stable way to generate short names is to compute a checksum on the parameters.
You then need a way to retrieve the original parameters from the checksum to generate the generated file (the <code>.o</code> file in our example).
In doing so, you must account for:</p>
<ul>
<li>robustness    : because such checksums are subject to the birthday paradox, you need either to deal with collisions are provide enough margin (roughly doubling the size) to avoid them.</li>
<li>repeatability : your system must not prevent you from being able to repeat a scenario that was generated some days, weeks, months earlier.</li>
<li>merging       : when you invent a name, think that some colleagues working on the same project may also invent names, and they may collide.
Tools such as <code>git</code> are there to help you in this process, but your scheme must be git friendly.</li>
<li>performance   : you must have a scheme that support as many code/value associations as necessary for your case, without spending most of its time searching for value when given a code.</li>
<li>communication : ideally, you may want to signal a bug to a colleague by just telling him "build that target, and you see the bug".
If the target refers to a code, he may need some further steps to create the code/value association, which goes against communication.</li>
</ul>
<h1 id="association-table-as-a-source"><a class="header" href="#association-table-as-a-source">association table as a source</a></h1>
<p>One way to deal with this case is to create a central database, with the following pros and cons:</p>
<ul>
<li>robustness    : collisions can easily be dealt with.</li>
<li>repeatability : this is a probleme. When dealing with collisions, some codes change, which change old repo because the database is not itself versioned. This is a serious problem.</li>
<li>merging       : no merging.</li>
<li>perfomance    : accessing the data in a performant way is easy. Detecting modifications so that open-lmake can take sound decisions may be more challenging.</li>
<li>communication : excellent, the database is shared</li>
<li>installation  : you need a server, configure clients to connect to it, etc. it is some work</li>
<li>maintainance  : as any central services, you may inadvertently enter wrong data, you need a way to administer it as it has the potential to block the whole team.</li>
</ul>
<p>The <code>lencode</code>/<code>ldecode</code> commands (or the <code>lmake.encode</code>/<code>lmake.decode</code> fonctions) are there to address this question.</p>
<p>The principle of operation is the following:</p>
<ul>
<li>There are a certain number of files storing code/value associations. These are sources seen from open-lmake, i.e. they are normally managed by <code>git</code>.</li>
<li>To keep the number of such files to a reasonably low level (say low compared to the overal number of sources), there are contexts, mostly used as a subdivision of files</li>
<li>So, a file provides a certain number of tables (the contexts), each table associating some codes with some values</li>
<li>These tables are stored in files as lines containing triplet : context, code, value</li>
<li>When reading, <code>lencode</code>/<code>ldecode</code> are very flexible. The files may contain garbage lines, duplicates, collisions, they are all ignored.
When 2 values are associated with the same code by 2 different lines, a new code is generated by lengthening one of them with further digites of the checksum computed on the value.
When 2 codes are associated with the same value by 2 different lines, only one code is retained, the shorter of the 2 (or any if of equal length).</li>
<li>When writing, <code>lencode</code>/<code>ldecode</code> are very rigid. File is generated sorted, with no garbage lines, nor duplicates, or collisions.</li>
<li>When open-lmake starts and read a file, it write it back in its canonical form.</li>
<li>When open-lmake runs, that <code>lencode</code> is used and generate new codes on the fly, additional lines are merely appended to the file.</li>
</ul>
<p>This has the following properties:</p>
<ul>
<li>Information is under git. No further server, central database, management, configuration etc.</li>
<li>repeatability is excellent. As long as you do not merge, your are insensitive to external activities.
When merging, the probability of collision depends on the length of the used codes, which is under user control.
Moreover, the length increasing automatically with collisions maintain the number of such collision to a reasonably low level, even in fully automatic mode.</li>
<li>Merging is very easy : actually one need not even merge. The simple collision file generated by <code>git</code> can be used as is. This makes this tool very <code>git</code> friendly.</li>
<li>Robustness is perfect : collisions are detected and dealt with.</li>
<li>Coherence is perfect : seen from open-lmake, each association is managed as a source.
If anything changes (i.e. a new value is associated with an old code or a new code is associated with an old value), the adequate jobs are rerun.</li>
<li>Performance is very good as the content of the file is cached in a performance friendly format by open-lmake. And update to the file is done by a simple append.
However, the file is sorted at every <code>lmake</code> command, making the content more rigid and the merge process easier.</li>
<li>Associations files can be editing by hand, so that human friendly codes may be associated to some heavily used values.
<code>lencode</code> will only generate codes from checksums, but will handle any code generated externally (manually or otherwise).
In case of collision and when open-lmake must suppress one of 2 codes, externally generated codes are given preference as they believed to be more readable.
If 2 externally generated codes collide, a numerical suffix is appended or incremented to solve the collision.</li>
</ul>
<h1 id="association-table-as-a-shared-dir"><a class="header" href="#association-table-as-a-shared-dir">association table as a shared dir</a></h1>
<p>Another scheme, much lighter but that requires more system level support, is to share a dir among repo's.
In that case, all associations are stored as individual files within this dir.
Such a dir must lie within a source dir and must contain a file <code>LMAKE/config.py</code> containing definitions for :</p>
<ul>
<li><code>file_sync</code> : one of <code>none</code>, <code>dir</code> (default) or <code>sync</code> for choosing the method to ensure proper consistent operations.</li>
</ul>
<h2 id="permissions"><a class="header" href="#permissions">Permissions</a></h2>
<p>For all users accessing the association table:</p>
<ul>
<li>Its root dir and its <code>LMAKE</code> dir must have read/write/execute access (read-only access is enough to only decode).</li>
<li>The <code>LMAKE/config.py</code> must have read access.</li>
</ul>
<p>If access permission is at group level, the setgid bit must be set, e.g. using <code>chmod g+s &lt;cache_dir&gt;</code>.
This operation may have to be done recursively if the root dir is already populated.</p>
<p>When the group has read/write/execute access, best (performance wise) is to set the default ACL, e.g. using:</p>
<p><code>setfacl -d -R -m u::rwX,g::rwX,o::- &lt;cache_dir&gt;</code></p>
<p>Similarly, when all users have read/write/execute access, best (performance wise) is to set the default ACL, e.g. using:</p>
<p><code>setfacl -d -R -m u::rwX,g::rwX,o::rwX &lt;cache_dir&gt;</code></p>
<h2 id="coherence"><a class="header" href="#coherence">Coherence</a></h2>
<p>Some file systems, such as NFS, lack coherence.
In that case, precautions must be taken to ensure coherence.</p>
<p>This can be achieved by setting the <code>file_sync</code> variable in <code>LMAKE/config.py</code> to:</p>
<div class="table-wrapper"><table><thead><tr><th>Value</th><th>Recommanded for</th><th>Default</th><th>Comment</th></tr></thead><tbody>
<tr><td><code>'none'</code></td><td>local disk, CEPH</td><td></td><td>no precaution, file system is coherent</td></tr>
<tr><td><code>'dir'</code></td><td>NFS</td><td>X</td><td>enclosing dir (recursively) is open before any read and closed after any write</td></tr>
<tr><td><code>'sync'</code></td><td></td><td></td><td><code>fsync</code> is called after any modification</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="cache.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="meta_data.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="cache.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="meta_data.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
